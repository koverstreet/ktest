#!/usr/bin/env bash

. "$(dirname "$(readlink -e "${BASH_SOURCE[0]}")")/../test-libs.sh"

config-no-kbuild
config-no-vm
config-timeout $((20 * 60))

test_system()
{
    local test_file
    local out_dir
    local build_dir
    local source_dir="$ktest_kernel_source"

    test_file=$(basename -s .ktest "$0")
    out_dir="$ktest_out/out/${test_file}.system"
    build_dir="$ktest_out/work/${test_file}.system/build"

    rm -rf "$build_dir"
    mkdir -p "$out_dir" "$build_dir"

    make -C "$source_dir" O="$build_dir" allmodconfig
    "$source_dir/scripts/config" \
        --file "$build_dir/.config" \
        --enable CONFIG_RUST \
        --enable CONFIG_RANDSTRUCT_NONE
    make -C "$source_dir" O="$build_dir" olddefconfig
    make -C "$source_dir" O="$build_dir" rust-analyzer

    local project="$build_dir/rust-project.json"
    cp "$project" "$out_dir/rust-project.json"

    local start_ns end_ns
    start_ns=$(date +%s%N)
    rust-analyzer analysis-stats "$project" \
        > "$out_dir/analysis-stats.txt"
    end_ns=$(date +%s%N)

    echo "elapsed_ms=$(((end_ns - start_ns) / 1000000))" \
        >> "$out_dir/analysis-stats.txt"
}

main "$@"
