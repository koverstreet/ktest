#!/usr/bin/env bash

. "$(dirname "$(readlink -e "${BASH_SOURCE[0]}")")/../prelude.sh"

config-mem 4G
config-no-vm
config-timeout $((20 * 60))

config-kconfig-base allmodconfig
config-kbuild-target rust-analyzer

require-kernel-config RUST
require-kernel-config RANDSTRUCT_NONE

test_system()
{
    local test_file=$(basename -s .ktest "$0")
    local out_dir="$ktest_out/out/${test_file}.system"
    mkdir -p "$out_dir"

    local project="$ktest_kernel_build/rust-project.json"
    cp "$project" "$out_dir/rust-project.json"

    local start_ns end_ns
    start_ns=$(date +%s%N)
    rust-analyzer analysis-stats "$project" \
        > "$out_dir/analysis-stats.txt"
    end_ns=$(date +%s%N)

    echo "elapsed_ms=$(((end_ns - start_ns) / 1000000))" \
        >> "$out_dir/analysis-stats.txt"
}

main "$@"
