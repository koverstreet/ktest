#!/usr/bin/env bash

. $(dirname $(readlink -e "${BASH_SOURCE[0]}"))/bcachefs-test-libs.sh

#require-git http://evilpiepirate.org/git/linuxquota.git
#require-make linuxquota

. $(dirname $(readlink -e "${BASH_SOURCE[0]}"))/../fstests.sh

require-kernel-config BCACHEFS_QUOTA
require-kernel-config QUOTA

[[ ! -v MKFS_OPTIONS ]] && export MKFS_OPTIONS="--encrypted --no_passphrase --errors=ro"
export FSTYP=bcachefs

run_test()
{
    if [[ ! -f /xfstests-init-done ]]; then
	bcachefs_antagonist
    fi

    # Expunges:
    # generic/064: we don't yet merge reflink pointers
    # generic/102: precise "write until fs is full" -ENOSPC semantics are not terribly useful
    # generic/275: precise "write until fs is full" -ENOSPC semantics are not terribly useful
    # generic/414: extents are smaller
    # generic/441: we don't yet support the fsync semantics of "only return an error once"
    # generic/558: extremely slow on bcachefs, mainly due to inodes being
    # smaller than other filesystems (thus we can fit a lot more)

    run_fstests -e generic/064,generic/102,generic/275,generic/414,generic/441,generic/558 "$@"

    bcachefs_test_end_checks ${ktest_scratch_dev[0]} ${ktest_scratch_dev[1]}
}

main "$@"
