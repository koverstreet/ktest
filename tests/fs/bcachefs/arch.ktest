#!/bin/bash

#export NO_BCACHEFS_DEBUG=1

. $(dirname $(readlink -e "${BASH_SOURCE[0]}"))/bcachefs-test-libs.sh

#require-kernel-config KASAN
#require-kernel-config KASAN_VMALLOC

require-kernel-config SECURITY
require-kernel-config SECURITY_LANDLOCK

config-scratch-devs 32G

config-mem 16G
config-cpus 12
config-timeout $(stress_timeout)

test_foo()
{
    #run_quiet "" mkfs.ext4 -F ${ktest_scratch_dev[0]}
    run_quiet "" bcachefs format -f ${ktest_scratch_dev[0]}
    mount ${ktest_scratch_dev[0]} /mnt

    (cd /mnt; tar xf /host/home/kent/arch-root-20250622.tar.zst)

    bcachefs subvolume create /mnt/target

    mkdir -p /mnt/root/.cargo
    cat > /mnt/root/.cargo/config.toml <<-ZZ
[build]
rustflags = [
  "-Clinker=clang",
  "-Clink-arg=-fuse-ld=/usr/bin/mold",
]
target-dir = "/target/"
ZZ

    mount --bind /dev /mnt/dev
    mount -t proc none /mnt/proc
    mount -t sysfs none /mnt/sys

    cp /etc/resolv.conf /mnt/etc

    cp -r /ktest-out/fd /mnt

    chroot /mnt /usr/bin/bash -c '
    pacman -S -y --noconfirm cargo clang mold
    cd /fd
    cargo build --release

    /target/release/fd
    '
}

main "$@"
