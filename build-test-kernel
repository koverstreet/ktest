#!/usr/bin/env bash

set -o nounset
set -o errexit
set -o errtrace

ktest_dir=$(dirname "$(readlink -f "$0")")
KTEST=$ktest_dir/ktest

. "$ktest_dir/lib/libktest.sh"

checkdep gcc
checkdep clang
checkdep make
checkdep bison
checkdep flex
checkdep bc

ktest_njobs=$(nproc)
ktest_precise=false
ktest_compiler="${CC:-gcc}"
ktest_skip_kernel_config=false

COVERAGE=""		# doing code coverage?
MAKEARGS=()
DEPMOD=depmod

if ! which depmod > /dev/null; then
    DEPMOD=/sbin/depmod
fi

usage()
{
    echo "build-test-kernel: Run generic virtual machine tests"
    echo "Usage: build-test-kernel cmd [options]"
    ktest_usage_cmds
    echo "  oldconfig           Run make oldconfig"
    echo "  config              Run make nconfig"
    echo
    echo "  options:"
    ktest_usage_opts
    echo
    echo " options for build-test-kernel run:"
    ktest_usage_run_opts
    echo "      -k <dir>        kernel source dir"
    echo "      -c <dir>        enable coverage for this dir (only valid without -K)"
    echo "      -M <arg>        extra arguments to be passed to make when building the kernel"
    echo "      -K              keep existing kernel .config"
    echo
    ktest_usage_post
}

if [[ $# = 0 ]]; then
    usage
    exit 1
fi

#parse command and shift for rest of arg parsing
CMD="$1"
shift

while getopts "k:Pc:M:Kh${ktest_args}" arg; do
    case $arg in
	k)
	    ktest_kernel_source="$OPTARG"
	    ;;
	P)
	    ktest_precise=true
	    ;;
	c)
	    if [[ ! -d $OPTARG ]]; then
		echo "$OPTARG must be a directory"
		exit 1
	    fi

	    checkdep lcov

	    # Strip trailing / from directory name, substitute _ for /
	    OPTARG=$(echo "${OPTARG%/}"|tr / _)
	    MAKEARGS+=("GCOV_PROFILE_$OPTARG=y")
	    COVERAGE=1
	    ;;
	M)
	    MAKEARGS+=("$OPTARG")
	    ;;
	K)
	    ktest_skip_kernel_config=true
	    ;;
	h)
	    usage
	    exit 0
	    ;;
    esac
    parse_ktest_arg $arg
done
shift $(( OPTIND - 1 ))

parse_args_post

# default parameters
[[ -z $ktest_kernel_source ]]	&& ktest_kernel_source="."

if [[ ! -d $ktest_kernel_source ]]; then
    echo "kernel source directory $ktest_kernel_source does not exist"
    exit 1
fi

ktest_kernel_source=$(readlink -e "$ktest_kernel_source")

ktest_kernel_build="$ktest_out/kernel_build.$ktest_arch"
mkdir -p "$ktest_kernel_build"

if [[ -n $CROSS_COMPILE ]]; then
    checkdep "$ARCH_TRIPLE-gcc" "gcc-$ARCH_TRIPLE"
fi

run_ktest()
{
    arg=$1
    shift

    "$KTEST" "$arg" $KTESTARGS "$@"
}

cmd_run()
{
    if [[ $# = 0 ]]; then
	echo "build-test-kernel: missing test"
	usage
	exit 1
    fi

    ktest_test=$(realpath "$1")
    shift
    ktest_testargs="$@"

    echo Running test $(basename "$ktest_test") on $(uname -n) at $(pwd)
    parse_test_deps "$ktest_test"

    if [[ -n $COVERAGE ]]; then
	ktest_kernel_config_require+=(GCOV_KERNEL)
    fi

    if ! $ktest_no_kbuild; then
	run_quiet "building kernel" build_kernel
    fi

    if $ktest_no_vm; then
	run_tests_host
    else
	start_vm
    fi
}

run_tests_host()
{
    local ret=0

    mkdir -p "$ktest_out/out"

    export ktest_kernel_source
    export ktest_kernel_build
    export ktest_out

    echo "Running tests on host: $ktest_tests"

    "$ktest_test" run-tests $ktest_tests || ret=$?

    if [[ $ret = 0 ]]; then
	echo "TEST PASSED"
    else
	echo "TEST FAILED"
    fi

    return $ret
}

cmd_boot()
{
    cmd_run "$ktest_dir/boot.ktest"
}

cmd_oldconfig()
{
    new_config
    do_make oldconfig
}

cmd_config()
{
    new_config
    do_make nconfig "$@"
}

cmd_faddr2line()
{
    ./scripts/faddr2line "$ktest_kernel_build/vmlinux" $@
}

cmd_help()
{
    usage
}

if [[ $(type -t "cmd_$CMD") == function ]]; then
    CMD="cmd_$CMD"
elif [[ $(type -t "ktest_$CMD") == function ]]; then
    CMD="ktest_$CMD"
else
    usage
    exit 1
fi

$CMD "$@"
